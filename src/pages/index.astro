---
import { getCollection } from 'astro:content';
import { ClientRouter } from 'astro:transitions';
import type { CollectionEntry } from 'astro:content';

interface SidebarPost {
  title: string;
  slug: string;
  date: string;
  tags: string[];
}

// 使用与PostLayout相同的数据源
let postsByCategory: Record<string, SidebarPost[]> = {};
try {
  const response = await fetch('/generated/sidebar.json');
  postsByCategory = await response.json() as Record<string, SidebarPost[]>;
} catch (err) {
  console.error('Failed to load sidebar data:', err);
  // Fallback to empty data
  postsByCategory = {};
}

// 获取所有文章用于首页展示
const posts = await getCollection('posts');

---
<!-- <ClientRouter /> -->
<div class="app-container">
  <aside class="sidebar">
    <script>
      // 保存侧边栏内容到localStorage
      document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
          localStorage.setItem('sidebarContent', sidebar.innerHTML);
        }
      });
    </script>
    {Object.entries(postsByCategory).map(([category, categoryPosts]) => (
      <section>
        <h2>{category}</h2>
        <ul>
          {categoryPosts.map(post => (
            <li>
              <a href={`/posts/${post.slug}`} data-astro-transition="animate">
                {post.title}
              </a>
              <time>{new Date(post.date).toLocaleDateString()}</time>
              {post.tags && post.tags.length > 0 && (
                <span> - {post.tags.join(', ')} </span>
              )}
            </li>
          ))}
        </ul>
      </section>
    ))}
  </aside>
  <main class="content" data-astro-transition="persist">
    <!-- Content will be dynamically replaced -->
  </main>
</div>

<style>
  .app-container {
    display: flex;
    gap: 2rem;
  }
  .sidebar {
    width: 300px;
    position: sticky;
    top: 1rem;
  }
  .content {
    flex: 1;
  }
</style>
