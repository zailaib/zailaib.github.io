---
import { ClientRouter } from 'astro:transitions';

interface Post {
  title: string;
  slug: string;
  date: string;
  tags?: string | string[];
}

export interface Props {
  frontmatter: {
    title: string;
    date: Date;
    category?: string;
    tags?: string | string[];
  }
}

const { frontmatter } = Astro.props as Props;
---
<html lang="zh">
<head>
  <title>{frontmatter.title}</title>
  <ClientRouter />
</head>
<body>
  <div class="app-container">
    <aside class="sidebar" data-astro-transition="persist">
      <div id="sidebar-content">
        <script>
          // 只在客户端执行
          if (typeof window !== 'undefined') {
            console.log('Loading sidebar data...');
            fetch('/generated/sidebar.json?t=' + Date.now())
            .then(res => {
              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
              return res.json();
            })
            .then((data: Record<string, Array<{title: string, slug: string}>>) => {
              console.log('Sidebar data loaded:', data);
              const container = document.getElementById('sidebar-content');
              if (container) {
                container.innerHTML = Object.entries(data)
                  .map(([category, posts]) => `
                    <section>
                      <h2>${category}</h2>
                      <ul>
                        ${posts.map(post => `
                          <li>
                            <a href="/posts/${post.slug}" data-astro-transition="animate">
                              ${post.title}
                            </a>
                          </li>
                        `).join('')}
                      </ul>
                    </section>
                  `).join('');
              }
            })
            .catch(err => {
              console.error('Failed to load sidebar:', err);
              const errorContainer = document.getElementById('sidebar-content');
              if (errorContainer) {
                errorContainer.innerHTML = `
                <div style="color:red">
                  Failed to load navigation. Please refresh the page.
                </div>
                `;
              }
            });
          }
        </script>
      </div>
    </aside>

    <main class="content">
      <article id="post-content" data-astro-transition="animate">
        <h1>{frontmatter.title}</h1>
        <slot /> <!-- Markdown 内容会插入到这里 -->
      </article>
    </main>
  </div>
</body>
</html>

<style>
  .app-container {
    display: flex;
    gap: 2rem;
  }
  .sidebar {
    width: 300px;
  }
  .content {
    flex: 1;
  }
</style>
