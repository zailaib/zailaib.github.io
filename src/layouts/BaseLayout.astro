---
import { ClientRouter } from 'astro:transitions';
import Sidebar from '../components/Sidebar.astro';
import Minimap from '../components/Minimap.astro';
import LanguageSwitcher from '../components/LanguageSwitcher.astro';
import { getCurrentLanguage, getTranslation } from '../i18n/utils';
import type { BaseLayoutProps, PostsByCategory } from '../types';

const { 
  title = 'Astro Basics', 
  showSidebar = true,
  showMinimap = true,
  sidebarData,
  currentSlug
} = Astro.props as BaseLayoutProps;

// åœ¨æ„å»ºæ—¶å¯¼å…¥é¢„ç”Ÿæˆçš„ä¾§è¾¹æ æ•°æ®
const defaultSidebarData = await import('../generated/sidebar.json');
const postsByCategory = sidebarData || (defaultSidebarData as any).default as PostsByCategory;

// è·å–å½“å‰è¯­è¨€
const currentLang = getCurrentLanguage(Astro.url.pathname);
const translation = getTranslation(currentLang);
---

<!doctype html>
<html lang={currentLang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{translation.common.siteTitle}</title>
	</head>
	<body>
    <!-- ç§»åŠ¨ç«¯å¯¼èˆªæ§åˆ¶æŒ‰é’® -->
    <div class="mobile-controls">
      <button class="mobile-toggle" id="sidebar-toggle" aria-label={translation.toggleNavigation}>â˜°</button>
      <button class="mobile-toggle" id="minimap-toggle" aria-label={translation.toggleMinimap}>ğŸ—ºï¸</button>
      <LanguageSwitcher currentPath={Astro.url.pathname} />
    </div>

    <div class="app-container">
      {showSidebar && (
        <aside class="sidebar-container" id="sidebar">
          <Sidebar postsByCategory={postsByCategory} />
        </aside>
      )}
      <main class="content" id="main-content">
        <slot />
      </main>
      {showMinimap && (
        <aside class="minimap-container" id="minimap">
          <Minimap currentSlug={currentSlug} />
        </aside>
      )}
    </div>
    <ClientRouter />

    <script is:inline src="/scripts/mobile-interaction.js"></script>
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
	}
  
  .app-container {
    display: grid;
    grid-template-columns: 300px 1fr 250px;
    gap: 2rem;
    padding: 1rem;
    max-width: 1400px;
    margin: 0 auto;
    min-height: 100vh;
    box-sizing: border-box;
  }
  
  .content {
    grid-column: 2;
    min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
  }
  
  .sidebar-container {
    grid-column: 1;
    position: sticky;
    top: 1rem;
    height: fit-content;
    max-height: calc(100vh - 2rem);
    overflow-y: auto;
    scrollbar-width: thin;
  }
  
  .minimap-container {
    grid-column: 3;
    position: sticky;
    top: 1rem;
    height: fit-content;
    max-height: calc(100vh - 2rem);
    overflow-y: auto;
    scrollbar-width: thin;
  }
  
  /* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® */
  .mobile-controls {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1001;
    gap: 0.5rem;
  }
  
  .mobile-toggle {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1200px) {
    .app-container {
      grid-template-columns: 280px 1fr 220px;
      gap: 1.5rem;
    }
  }
  
  @media (max-width: 1024px) {
    .app-container {
      grid-template-columns: 250px 1fr;
    }
    
    .minimap-container {
      display: none;
    }
  }
  
  @media (max-width: 768px) {
    .app-container {
      grid-template-columns: 1fr;
      gap: 1rem;
      padding: 0.5rem;
    }
    
    .sidebar-container,
    .minimap-container {
      display: none;
    }
    
    .mobile-controls {
      display: flex;
    }
    
    .sidebar-container.mobile-visible,
    .minimap-container.mobile-visible {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 85%;
      height: 100vh;
      background: white;
      z-index: 1000;
      padding: 1rem;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }
    
    .minimap-container.mobile-visible {
      left: auto;
      right: 0;
      width: 75%;
      animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  }
  
  @media (max-width: 480px) {
    .app-container {
      padding: 0.25rem;
    }
    
    .sidebar-container.mobile-visible {
      width: 90%;
    }
    
    .minimap-container.mobile-visible {
      width: 85%;
    }
  }
</style>
